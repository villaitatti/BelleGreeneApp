    <semantic-query
        query='
            SELECT DISTINCT ?letter ?identifier ?title ?recipient ?place ?begin_date ?letterhead ?n_pages ?notes ?material WHERE { 

                ?letter crm:P16i_was_used_for ?exchange_activity;
                    crm:P108i_was_produced_by ?production;
                    rdfs:label ?title;
                    crm:P48_has_preferred_identifier ?identifier_node.

                ?identifier_node rdfs:label ?identifier.

                OPTIONAL {
                    ?production crm:P7_took_place_at ?place;
                }

                OPTIONAL {
                  ?letter crm:P1_is_identified_by ?letterhead.
                  ?letterhead crm:P2_has_type <https://bellegreene.itatti.harvard.edu/resource/type/letterhead>.
                }

                OPTIONAL {
                  SELECT ?letter (count(?pages) as ?n_pages) WHERE {
                    ?pages bg:part_of ?letter.
                  } GROUP BY ?letter
                }

                OPTIONAL {
                  ?letter crm:P1_is_identified_by ?notes.
                  ?notes crm:P2_has_type <https://bellegreene.itatti.harvard.edu/resource/type/notes>.
                }

                OPTIONAL {
                  ?letter crm:P1_is_identified_by ?material.
                  ?material crm:P2_has_type <https://bellegreene.itatti.harvard.edu/resource/type/accompanying_material>.
                }

                ?production crm:P4_has_time-span ?production_time_span.
            
                ?production_time_span rdfs:label ?begin_date.

                ?exchange_activity rdf:type crm:E7_Activity;
                    crm:P01i_is_domain_of ?recipient_activity.

                ?recipient_activity a crm:PC14_carried_out_by;
                    crm:P14.1_in_the_role_of  <https://bellegreene.itatti.harvard.edu/resource/type/Recipient>;
                    crm:P02_has_range ?recipient.

                BIND(<[[this]]> as ?letter)
                }'
        template="{{> metadata}}"
    >

    <template id="metadata">

        {{#each bindings}}

            <div id="letter" class="container">

              <bs-row>
                  <bs-col sm="12" md="12">
                      <h1 class="heading">{{title.value}}</h1>
                  </bs-col>
              </bs-row>

              
              <bs-row>
                <bs-tabs>
                  <bs-tab event-key="1" title="GENERAL INFORMATION">
                    <p>
                      {{#if begin_date}}<strong>Date: </strong>{{begin_date.value}}{{/if}}
                      {{#if recipient}}<br><strong>Recipient: </strong><mp-label iri="{{recipient.value}}"></mp-label>{{/if}}
                      {{#if place}}<br><strong>Place letter was written: </strong><mp-label iri="{{place.value}}"></mp-label>{{/if}}
                      {{#if letterhead}}<br><strong>Letterhead: </strong><mp-label iri="{{letterhead.value}}"></mp-label>{{/if}}
                      {{#if n_pages}}<br><strong>Number of pages: </strong>{{n_pages.value}}{{/if}}
                      {{#if notes}}<br><strong>Notes: </strong><mp-label iri="{{notes.value}}"></mp-label>{{/if}}
                      {{#if material}}<br><strong>Accompanying Material: </strong><mp-label iri="{{material.value}}"></mp-label>{{/if}}
                     <semantic-query
                        query='
                            SELECT DISTINCT ?transcriber WHERE { 
                                <[[this]]> crm:P16i_was_used_for ?transcription.
                                ?transcription a crm:E7_Activity;
                                    crm:P01i_is_domain_of ?transcription_activity.
                                
                                ?transcription_activity a crm:PC14_carried_out_by;
                                    crm:P14.1_in_the_role_of  <https://bellegreene.itatti.harvard.edu/resource/type/transcriber>;
                                    crm:P02_has_range ?transcriber.
                            }'
                        template="{{> transcribers}}"
                      > 
                      
                       <template id="transcribers">
                            {{#if bindings}}
                              <br><strong>Transcribers </strong>
                              {{#each bindings}}
                                  <mp-label iri="{{transcriber.value}}"></mp-label>;  
                              {{/each}}
                            {{/if}}
                            <br>
                        </template>
                    </p>
                    <p>
                      <semantic-query
                        query='
                            SELECT DISTINCT ?person WHERE { 
                                <[[this]]> crm:P67_refers_to ?person.
                            }'
                        template="{{> people}}"
                      >
                        <template id="people">
                            {{#if bindings}}
                              <strong>People Mentioned: </strong>
                              {{#each bindings}}
                                  <semantic-link iri="{{person.value}}"></semantic-link>;  
                              {{/each}}
                            {{/if}}
                            <br>
                        </template>
                      </semantic-query> 
                    </p>
                    <p>
                      <semantic-query
                        query='
                            SELECT DISTINCT ?content_lbl WHERE { 
                                <[[this]]> crm:P129i_is_subject_of ?content.
                                ?content rdfs:label ?content_lbl.
                            }'
                        template="{{> contents}}"
                      >
                        <template id="contents">
                            {{#if bindings}}
                              <strong>Letter contents: </strong>
                              {{#each bindings}}<span>{{content_lbl.value}}; </span>{{/each}}
                            {{/if}}
                            <br>
                        </template>
                      </semantic-query> 
                    </p>
                    <p>
                      <semantic-query
                        query='
                            SELECT DISTINCT ?sub WHERE { 
                                <[[this]]> crm:P129_is_about ?sub.
                            }'
                        template="{{> subjects}}"
                      >
                        <template id="subjects">
                            {{#if bindings}}
                              <strong>Subjects: </strong>
                              {{#each bindings}}<semantic-link iri="{{sub.value}}"></semantic-link>; {{/each}}
                            {{/if}}
                            <br>
                        </template>
                      </semantic-query> 
                    </p>
                  </bs-tab>


                  <bs-tab event-key="2" title="ARCHIVAL REFERENCES">
                    <p>
                      {{#if letter_n}}<strong>Letter Number: </strong>{{letter_n.value}}{{/if}}
                      {{#if box_n}}<br><strong>Box Number: </strong>{{box_n.value}}{{/if}}
                      {{#if folder_n}}<br><strong>Folder Number: </strong>{{folder_n.value}}{{/if}}
                      {{#if itatti_n}}<br><strong>I Tatti Letter Number: </strong>{{itatti_n.value}}{{/if}}
                    </p>
                    <p>
                      {{#if cite}}<br><strong>Cite as: </strong>{{cite.value}}{{/if}}
                    </p>
                  </bs-tab>
                </bs-tabs>
              </bs-row>

                <bs-row id="pages">
                    <bs-col sm="12" md="12">
                        <semantic-table 
                            id='table-result'
                            query='SELECT DISTINCT ?subject ?index ?document ?imageIRI ?imageIIIF ?page WHERE { 
                                ?page bg:part_of ?subject;
                                    crm:P129i_is_subject_of ?document;
                                    bg:index ?index;
                                    crm:P183i_has_representation ?imageIRI;
                                    crm:P183i_has_representation ?imageIIIF.

                                ?imageIRI crm:P2_has_type bg:thumbnail_img.
                                ?imageIIIF crm:P2_has_type bg:iiif_img.

                                BIND(xsd:integer(?index) as ?index_num)
                                BIND(<[[this]]> as ?subject)

                            } ORDER BY ASC(?index_num)'

                            tuple-template="{{> table-row}}"
                            options='{
                                "showTableHeading": false,
                                "showFilter": false
                            }'
                            number-of-displayed-rows="10">

                            <template id="table-row">
                                <bs-row class="row">
                                    <mp-event-proxy 
                                        id='proxy-page-{{index.value}}' 
                                        on-event-source='text-annotation-filter' 
                                        proxy-event-type='TextAnnotation:highlightText' 
                                        proxy-targets='["page-{{index.value}}"]'
                                    ></mp-event-proxy>
                                    <bs-col sm="7" md="7">
                                        {{>text}}
                                    </bs-col>
                                    <bs-col sm="4" md="4">
                                        {{>image}}
                                    </bs-col>
                                </bs-row>
                            </template>

                            <template id="text">
                                <rs-text-annotation-workspace
                                    id="page-{{index.value}}"
                                    storage="bellegreene"
                                    document-iri="{{document.value}}"
                                    annotation-subject-template="https://belle-greene.com/annotation/{{{{raw}}}}{{UUID}}{{{{/raw}}}}"
                                    fallback-template="{{> fallback-template}}"
                                    annotation-tooltip="{{> annotation-tooltip}}">

                                    <template id="fallback-template">
                                        Missing type for annotation <semantic-link iri="{{ iri.value }}"></semantic-link>
                                    </template>

                                    <template id="annotation-tooltip">
                                    <div>
                                        {{#if allowEdit}}
                                        <button
                                        name="edit"
                                        class="btn btn-xs btn-default"
                                        data-annotation="{{ iri.value }}"
                                        title="Edit annotation"
                                        >
                                        <span class="fa fa-pencil" style="pointer-events: none;"></span>
                                        </button>
                                        {{else}}
                                        <button
                                        name="edit"
                                        class="btn btn-xs btn-default"
                                        disabled
                                        title="Edit annotation"
                                        >
                                        <span class="fa fa-pencil" style="pointer-events: none;"></span>
                                        </button>
                                        {{/if}}
                                        {{#if allowDelete}}
                                        <button
                                        name="delete"
                                        class="btn btn-xs btn-default"
                                        data-annotation="{{ iri.value }}"
                                        title="Delete annotation"
                                        >
                                        <span class="fa fa-trash" style="pointer-events: none;"></span>
                                        </button>
                                        {{else}}
                                        <button
                                        name="delete"
                                        class="btn btn-xs btn-default"
                                        disabled
                                        title="Delete annotation"
                                        >
                                        <span class="fa fa-trash" style="pointer-events: none;"></span>
                                        </button>
                                        {{/if}}
                                    </div>
                                    </template>

                                </rs-text-annotation-workspace>
                            </template>

                            <template id="image">
                                <mp-overlay-dialog title="Mirador Viewer" type="modal" bs-size="large">
                                    <mp-overlay-dialog-trigger><img src="{{imageIRI.value}}" alt=""></mp-overlay-dialog-trigger>
                                    <mp-overlay-dialog-content>
                                        <rs-iiif-mirador
                                            image-or-region='{{imageIIIF.value}}'
                                            image-id-pattern='BIND( {{imageIIIF}} AS ?imageIRI)
                                                            BIND("image" AS ?type)
                                                            BIND(REPLACE(STR(REPLACE(STR(?imageIRI),"/full/full/0/default.jpg","")), "(^.*)\\/(.*)$", "$2") AS ?imageID)'
                                            iiif-server-url="https://iiif.itatti.harvard.edu/iiif/2">
                                        </rs-iiif-mirador>
                                    </mp-overlay-dialog-content>
                                </mp-overlay-dialog>
                            </template>

                        </semantic-table>
                    </bs-col>
                </bs-row>
            </div>

        {{/each}}

    </template>

</semantic-query>


